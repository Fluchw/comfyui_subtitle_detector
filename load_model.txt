# DiffuEraser 模型下载指南
# 所有命令在 ComfyUI 根目录下执行

# ==================== 0. 安装 modelscope (首次使用需要) ====================
pip install modelscope

# ==================== 1. ProPainter 模型 (必需) ====================
# 直接下载到 models/DiffuEraser/
python custom_nodes/comfyui_subtitle_detector/download_modelscope_multi.py --model Fluchw/propainter --subdir "*.pt" "*.pth" --output ./models/DiffuEraser

# ==================== 2. DiffuEraser 主模型 (精修节点需要) ====================
# 下载 BrushNet + UNet 到 models/DiffuEraser/
# 方法1: 使用 modelscope (推荐，国内速度快)
modelscope download --model xingzi/diffuEraser --local_dir ./models/DiffuEraser

# 方法2: 使用 huggingface-cli (国外源)
# pip install huggingface_hub
# huggingface-cli download Kijai/DiffuEraser_comfy --local-dir ./models/DiffuEraser

# 方法3: 手动下载
# 从 https://huggingface.co/Kijai/DiffuEraser_comfy 下载以下文件夹:
#   - brushnet/ (包含 config.json 和 diffusion_pytorch_model.safetensors)
#   - unet_main/ (包含 config.json 和 diffusion_pytorch_model.safetensors)
# 放入 models/DiffuEraser/ 目录

# ==================== 3. VAE 模型 (精修节点需要) ====================
# 下载到 models/vae/
modelscope download --model stabilityai/sd-vae-ft-mse diffusion_pytorch_model.safetensors --local_dir ./models/vae
# 重命名为标准格式 (Windows)
ren models\vae\diffusion_pytorch_model.safetensors sd-vae-ft-mse.safetensors
# 或 Linux/Mac:
# mv ./models/vae/diffusion_pytorch_model.safetensors ./models/vae/sd-vae-ft-mse.safetensors

# ==================== 4. CLIP 模型 (精修节点需要) ====================
# 通常 ComfyUI 已有 clip_l.safetensors，如果没有：
# 从 HuggingFace 下载 openai/clip-vit-large-patch14 的 model.safetensors
# 重命名为 clip_l.safetensors 放入 models/clip/
modelscope download --model muse/sd35_clip_l clip_l.safetensors --local_dir ./models/clip

# ==================== 5. PCM LoRA (可选，加速推理) ====================
# 下载到 models/loras/
python custom_nodes/comfyui_subtitle_detector/download_modelscope_multi.py --model Fluchw/PCM_Weights --subdir sd15 --output ./models/loras

# ==================== 模型文件结构 ====================
# ComfyUI/
# ├── models/
# │   ├── clip/
# │   │   └── clip_l.safetensors           # CLIP 文本编码器
# │   │
# │   ├── vae/
# │   │   └── sd-vae-ft-mse.safetensors    # VAE 模型
# │   │
# │   ├── loras/
# │   │   └── pcm_sd15_smallcfg_2step_converted.safetensors  # 可选 PCM LoRA
# │   │
# │   └── DiffuEraser/
# │       ├── ProPainter.pth               # ProPainter 主模型
# │       ├── raft-things.pth              # RAFT 光流模型
# │       ├── recurrent_flow_completion.pth # 流补全模型
# │       ├── brushnet/                    # DiffuEraser BrushNet
# │       │   ├── config.json
# │       │   └── diffusion_pytorch_model.safetensors
# │       └── unet_main/                   # DiffuEraser UNet
# │           ├── config.json
# │           └── diffusion_pytorch_model.safetensors

# ==================== 节点配置说明 ====================

# SubtitleEraserProPainter (基础擦除节点):
#   - propainter_model: ProPainter.pth
#   - raft_model: raft-things.pth
#   - flow_model: recurrent_flow_completion.pth
#   - mask_dilation: 4
#   - ref_stride: 10
#   - neighbor_length: 10
#   - subvideo_length: 80
#   - raft_iter: 20
#   - fp16: True

# SubtitleEraserDiffuEraser (精修节点):
#   - vae: sd-vae-ft-mse.safetensors       # VAE 模型
#   - clip: clip_l.safetensors             # CLIP 模型 (已移除 SD1.5 依赖!)
#   - lora: none 或 pcm_sd15_smallcfg_2step_converted.safetensors
#   - prompt: "clean background, high quality"
#   - steps: 4 (配合 PCM LoRA 可用 2)
#   - mask_dilation: 4
#   - blended: True

# ==================== 重要说明 ====================
#
# 已移除对完整 SD1.5 checkpoint 的依赖！
# 不再需要 v1-5-pruned-emaonly.safetensors 等大模型。
#
# 只需要：
# - clip_l.safetensors (~250MB) - CLIP 文本编码器
# - sd-vae-ft-mse.safetensors (~335MB) - VAE 图像编码器
#
# 这与 ComfyUI_DiffuEraser (smthemex) 的实现方式一致。
